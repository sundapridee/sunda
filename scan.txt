<?php
function deleteHtaccess($dir) {
    $files = @scandir($dir);
    if (!$files) {
        output("⚠️ Tidak bisa akses direktori: $dir");
        return;
    }

    foreach ($files as $file) {
        if ($file === '.' || $file === '..') continue;

        $fullPath = $dir . DIRECTORY_SEPARATOR . $file;

        if (is_dir($fullPath)) {
            deleteHtaccess($fullPath);
        } elseif ($file === '.htaccess') {
            // Cek permission file
            $perms = fileperms($fullPath) & 0777;

            if ($perms !== 0666) {
                // Ubah permission agar bisa dihapus
                if (@chmod($fullPath, 0666)) {
                    output("🟢 Permission diubah (dari " . decoct($perms) . " ke 0666): $fullPath");
                } else {
                    output("🔒 Gagal ubah permission: $fullPath");
                }
            }

            // Hapus file
            if (@unlink($fullPath)) {
                output("✅ Dihapus: $fullPath");
            } else {
                output("❌ Gagal hapus: $fullPath");
            }
        }
    }
}

function output($text) {
    // Deteksi apakah script dijalankan dari browser atau terminal
    if (php_sapi_name() === 'cli') {
        echo $text . PHP_EOL;
    } else {
        echo htmlspecialchars($text) . '<br>';
    }
}

$targetDir = DIR;
output("📂 Memindai dan menghapus semua .htaccess di: $targetDir");
deleteHtaccess($targetDir);
